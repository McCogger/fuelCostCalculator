name: Parse Fuel Price

on:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  parse-fuel-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install xlsx

      - name: Create parser script using require()
        run: |
          mkdir -p scripts
          cat << 'EOF' > scripts/generateFuelPriceJson.js
          const XLSX = require('xlsx')
          const fs = require('fs')
          const path = require('path')

          const inputPath = path.join('data', 'latest.xlsx')
          const outputPath = path.join('data', 'fuel-price.json')

          try {
              const workbook = XLSX.readFile(inputPath)
              const sheetName = workbook.SheetNames[0]
              const sheet = workbook.Sheets[sheetName]
              const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 })

              const italyRow = rows.find(row =>
                  row.some(cell => typeof cell === 'string' && cell.trim().toLowerCase() === 'italy')
              )

              if (!italyRow) throw new Error('Italy row not found.')

              const fuelPrice = italyRow.find(cell => typeof cell === 'number')

              if (!fuelPrice) throw new Error('Fuel price not found.')

              const result = {
                  country: 'Italy',
                  fuel_price: fuelPrice
              }

              fs.writeFileSync(outputPath, JSON.stringify(result, null, 2))
              console.log(`✅ fuel-price.json generated: €${fuelPrice} per liter`)
          } catch (error) {
              console.error('❌ Error:', error.message)
              process.exit(1)
          }
          EOF

      - name: Run parser
        run: node scripts/generateFuelPriceJson.js

      - name: Commit and push fuel-price.json
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add data/fuel-price.json
          git commit -m "Auto-generate fuel-price.json from latest.xlsx"
          git push
